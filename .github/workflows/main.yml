name: â™¾ï¸ CI - Build & Verify Diploma Online Library (Docker Compose)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  Build-And-Verify:
    name: ğŸ—ï¸ Build, Launch & Test Services
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout Source Code
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Set Up Docker Buildx (for multi-platform builds)
      - name: ğŸ³ Set Up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3ï¸âƒ£ Cache Docker Layers (improves build speed)
      - name: ğŸ§± Cache Docker Layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-
      # 4ï¸âƒ£ Build All Docker Services
      - name: ğŸ”¨ Build Docker Images
        run: |
          echo "ğŸš§ Building all services defined in docker-compose.yml..."
          docker compose -f docker-compose.yml build --progress=plain
      # 5ï¸âƒ£ Start Application Stack
      - name: ğŸš€ Launch Application Stack
        run: |
          echo "ğŸŸ¡ Starting all containers..."
          docker compose -f docker-compose.yml up -d
          echo "ğŸŸ¢ Containers launched successfully."
      # 6ï¸âƒ£ Wait for Initialization (Database / Backend)
      - name: â± Wait for Service Startup
        run: |
          echo "â³ Waiting 20 seconds for containers to fully initialize..."
          sleep 20
      # 7ï¸âƒ£ List Running Containers (for verification)
      - name: ğŸ§© Verify Running Containers
        run: docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      # 8ï¸âƒ£ Backend Health Check (Swagger or API)
      - name: ğŸ’š Backend Health Check
        run: |
          echo "ğŸ” Checking backend service availability..."
          curl -f http://localhost:5000/swagger \
            && echo "ğŸŸ¢ Backend is reachable and healthy." \
            || (echo "ğŸ”´ Backend not responding!" && docker compose logs && exit 1)
      # 9ï¸âƒ£ Frontend Health Check (if applicable)
      - name: âš›ï¸ Frontend Health Check
        continue-on-error: true
        run: |
          echo "ğŸŸ¢ Verifying frontend container is running..."
          curl -I http://localhost:3000 || echo "âš ï¸ Frontend check skipped (port 3000 not reachable)."
      # ğŸ”Ÿ Capture Logs on Failure
      - name: ğŸªµ Export Docker Logs (on failure)
        if: failure()
        run: |
          echo "âš ï¸ Build or health check failed. Capturing logs..."
          docker compose logs > docker_logs.txt
      - name: ğŸ“¦ Upload Logs as Artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs
          path: docker_logs.txt

      # 11ï¸âƒ£ Cleanup (Always)
      - name: ğŸ§¹ Stop and Clean Containers
        if: always()
        run: |
          echo "ğŸ§½ Cleaning up Docker environment..."
          docker compose -f docker-compose.yml down -v --remove-orphans
          echo "ğŸ§¼ Cleanup complete."
